<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora</title>
  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --accent:#06b6d4;
      --btn:#1f2937;
      --btn-hover:#374151;
      --text:#e6eef6;
      --muted:#9aa4b2;
      --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071126 0%, #0b1530 100%);display:flex;align-items:center;justify-content:center;padding:24px;color:var(--text);}
    .calc { width: 360px; max-width: 96vw; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; padding:18px; box-shadow: 0 8px 30px rgba(2,6,23,0.65), inset 0 1px 0 rgba(255,255,255,0.02); }
    .display { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:10px; padding:14px 12px; min-height:64px; margin-bottom:14px; display:flex; flex-direction:column; justify-content:center; }
    .history { font-size:13px; color:var(--muted); min-height:18px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .result { font-size:28px; font-weight:600; color:var(--text); text-align:right; word-break:break-all; }
    .pad { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    button { background:var(--btn); border:0; padding:14px; border-radius:10px; color:var(--text); font-size:18px; cursor:pointer; user-select:none; transition:transform 0.06s ease, background 0.12s ease; box-shadow: 0 4px 10px rgba(2,6,23,0.5); }
    button:active{transform:translateY(1px) scale(.998);} button:hover{background:var(--btn-hover);}
    .op { background:linear-gradient(180deg,var(--panel),#12202b); color:var(--accent); font-weight:600; }
    .wide { grid-column: span 2; }
    .danger { background:linear-gradient(180deg,#3b0f0f,#501212); color:#fff; }
    .small { font-size:16px; padding:10px; }
    footer { margin-top:12px; font-size:12px; color:var(--muted); text-align:center; }
    @media (max-width:420px){ .result{font-size:22px;} button{padding:12px;font-size:16px;} }
  </style>
</head>
<body>
  <main class="calc" aria-label="Calculadora">
    <section class="display" role="region" aria-live="polite">
      <div class="history" id="history">&nbsp;</div>
      <div class="result" id="result">0</div>
    </section>

    <section class="pad" role="group" aria-label="Teclado da calculadora">
      <button class="small danger" data-action="clear" title="Esc â€” Limpar">C</button>
      <button class="small" data-action="del" title="Backspace â€” Apagar">âŒ«</button>
      <button class="small" data-value="%" title="Percent">%</button>
      <button class="op" data-value="/" title="Dividir">Ã·</button>

      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button class="op" data-value="*" title="Multiplicar">Ã—</button>

      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button class="op" data-value="-" title="Subtrair">âˆ’</button>

      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button class="op" data-value="+" title="Somar">+</button>

      <button class="wide" data-value="0">0</button>
      <button data-value=".">.</button>
      <button class="op" data-action="equals" title="Enter â€” Igual">=</button>
    </section>

    <footer>Calculadora simples â€” suporte a teclado, % relativo (para +/âˆ’) e validaÃ§Ã£o bÃ¡sica. ðŸ”¨ðŸ¤–ðŸ”§</footer>
  </main>

  <script>
    (function(){
      const resultEl = document.getElementById('result');
      const historyEl = document.getElementById('history');
      const pad = document.querySelector('.pad');

      let expression = '';
      let lastResult = null;

      function render(){
        historyEl.textContent = expression || '\u00A0';
        resultEl.textContent = expression || '0';
      }

      function appendValue(val){
        if (val === '.') {
          const tokens = expression.split(/[\+\-\*\/\(\)]/);
          const last = tokens[tokens.length - 1];
          if (last.includes('.')) return;
          if (last === '') { expression += '0.'; render(); return; }
        }

        if (/[+\-*/]/.test(val)) {
          if (expression === '' && val !== '-') return;
          if (/[+\-*/]$/.test(expression)) {
            expression = expression.replace(/[+\-*/]+$/, val);
            render();
            return;
          }
        }

        expression += val;
        render();
      }

      function del(){
        if (!expression) return;
        expression = expression.slice(0, -1);
        render();
      }

      function clearAll(){
        expression = '';
        lastResult = null;
        render();
      }

      // Sanitiza expressÃ£o e converte porcentagens.
      // Comportamento:
      // - "num%" => (num/100) por padrÃ£o
      // - Mas transformamos "A + B%" ou "A - B%" em "A + (A*B/100)" / "A - (A*B/100)"
      function sanitizeForEval(expr){
        // Substitui sinais visuais
        expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/âˆ’/g, '-');
        expr = expr.replace(/\s+/g, '');

        // Converte primeiro 'n%' -> (n/100)
        expr = expr.replace(/(\d+(\.\d+)?)%/g, '($1/100)');

        // Agora lidamos com o comportamento especial para + e -
        // Procuramos padrÃµes: <left><op><(num/100)> e quando op for + ou -,
        // substituÃ­mos (left op (num/100)) por (left op (left * num / 100))
        // Regex captura left number e num/100
        // Exemplo: 12-(8/100) => becomes 12-(12*8/100)
        expr = expr.replace(/(\d+(\.\d+)?)([+\-])\((\d+(\.\d+)?)\/100\)/g, (m, left, _1, op, pct) => {
          // Para + ou -, queremos usar left * pct / 100
          // Resultado: left op (left * pct / 100)
          return `${left}${op}(${left}*${pct}/100)`;
        });

        // Validar caracteres permitidos
        if (!/^[0-9+\-*/().]+$/.test(expr)) {
          throw new Error('ExpressÃ£o contÃ©m caracteres invÃ¡lidos.');
        }

        return expr;
      }

      function evaluateExpression(){
        if (!expression) return;
        try {
          const safe = sanitizeForEval(expression);
          const fn = new Function('return ' + safe);
          const value = fn();
          if (!isFinite(value)) throw new Error('Resultado nÃ£o finito');
          lastResult = value;
          // formatar para mostra vÃ­rgula decimal de acordo com locale pt-BR? Mantemos '.' internamente, exibimos com ponto
          expression = String(value);
          render();
        } catch (err) {
          resultEl.textContent = 'Erro';
          console.warn('AvaliaÃ§Ã£o falhou:', err);
        }
      }

      pad.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if (!btn) return;
        const val = btn.getAttribute('data-value');
        const action = btn.getAttribute('data-action');

        if (action === 'clear') { clearAll(); return; }
        if (action === 'del') { del(); return; }
        if (action === 'equals') { evaluateExpression(); return; }

        if (val) appendValue(val);
      });

      window.addEventListener('keydown', (ev) => {
        const k = ev.key;
        if ((k >= '0' && k <= '9') || ['+','-','*','/','(',')','.','%'].includes(k)) {
          ev.preventDefault();
          appendValue(k);
          return;
        }
        if (k === 'Enter' || k === '=') {
          ev.preventDefault();
          evaluateExpression();
          return;
        }
        if (k === 'Backspace') {
          ev.preventDefault();
          del();
          return;
        }
        if (k === 'Escape') {
          ev.preventDefault();
          clearAll();
          return;
        }
      });

      render();
    })();
  </script>
</body>
</html>
